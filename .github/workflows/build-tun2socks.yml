name: Build tun2socks Android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Clone tun2socks source
        run: |
          git clone https://github.com/xjasonlyu/tun2socks.git src

      - name: Build Android libs
        run: |
          cd src

          mkdir -p output

          # ARM64
          GOOS=android GOARCH=arm64 CGO_ENABLED=1 \
            CC="$(go env GOROOT)/misc/ios/clangwrap.sh" \
            go build -buildmode=c-shared -o output/tun2socks-arm64.so ./tun2socks

          # ARMv7
          GOOS=android GOARCH=arm CGO_ENABLED=1 \
            CC="$(go env GOROOT)/misc/ios/clangwrap.sh" \
            go build -buildmode=c-shared -o output/tun2socks-arm.so ./tun2socks

          # x86_64
          GOOS=android GOARCH=amd64 CGO_ENABLED=1 \
            CC="$(go env GOROOT)/misc/ios/clangwrap.sh" \
            go build -buildmode=c-shared -o output/tun2socks-amd64.so ./tun2socks

          # x86
          GOOS=android GOARCH=386 CGO_ENABLED=1 \
            CC="$(go env GOROOT)/misc/ios/clangwrap.sh" \
            go build -buildmode=c-shared -o output/tun2socks-x86.so ./tun2socks

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tun2socks-libs
          path: src/output/*.so
