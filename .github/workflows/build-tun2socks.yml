name: Build tun2socks for Android

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build binaries
      run: |
        # ติดตั้ง Go
        sudo apt-get update
        sudo apt-get install -y golang-go
        
        # ดาวน์โหลด NDK
        wget -q https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
        unzip -q android-ndk-r25b-linux.zip
        export NDK_HOME=$(pwd)/android-ndk-r25b
        
        # โคลน tun2socks
        git clone --depth 1 https://github.com/xjasonlyu/tun2socks.git
        
        # เข้าไปที่ directory
        cd tun2socks
        
        # ตรวจสอบและ build
        echo "Building tun2socks..."
        
        # Build ARM64
        GOOS=android GOARCH=arm64 \
        CGO_ENABLED=1 \
        CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang \
        go build -o ../tun2socks-arm64
        
        # Build ARMv7
        GOOS=android GOARCH=arm \
        CGO_ENABLED=1 \
        CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang \
        go build -o ../tun2socks-armv7
        
        cd ..
        
        # เปลี่ยนชื่อไฟล์
        mv tun2socks-arm64 tun2socks-android-arm64
        mv tun2socks-armv7 tun2socks-android-armv7
        
        # ตั้งค่า executable
        chmod +x tun2socks-android-*
        
        echo "Build completed!"
        ls -lh tun2socks-android-*
    
    - name: Upload binaries
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-android
        path: |
          tun2socks-android-arm64
          tun2socks-android-armv7
