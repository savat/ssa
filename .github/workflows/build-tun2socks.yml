name: Build tun2socks for Android

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # อนุญาตให้ trigger เองได้

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Set up Android NDK
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r25b-linux.zip
        unzip android-ndk-r25b-linux.zip
        echo "NDK_HOME=$(pwd)/android-ndk-r25b" >> $GITHUB_ENV
    
    - name: Clone tun2socks
      run: |
        git clone https://github.com/xjasonlyu/tun2socks
        cd tun2socks
    
    - name: Build for Android ARM64
      run: |
        cd tun2socks
        export GOOS=android
        export GOARCH=arm64
        export CGO_ENABLED=1
        export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang
        go build -o ../tun2socks-android-arm64 -trimpath -ldflags="-s -w" ./cmd/tun2socks
    
    - name: Build for Android ARMv7
      run: |
        cd tun2socks
        export GOOS=android
        export GOARCH=arm
        export CGO_ENABLED=1
        export CC=$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang
        go build -o ../tun2socks-android-armv7 -trimpath -ldflags="-s -w" ./cmd/tun2socks
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          tun2socks-android-arm64
          tun2socks-android-armv7
        tag_name: android-v1.0
        name: Android Build
        body: |
          tun2socks for Android
          
          Files:
          - tun2socks-android-arm64 (ARM64 devices)
          - tun2socks-android-armv7 (ARMv7 devices)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
